<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" id="tab-favicon" href="favicon.png" />
  <title>Mail</title>
  <link rel="stylesheet" href="/assets/css/global.css?v=6" />
  <link rel="stylesheet" href="/assets/css/h.css?v=01" />
  <link rel="stylesheet" href="/assets/css/nav.css?v=01" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .mail-layout {
      display: flex;
      position: fixed;
      top: 80px;
      left: 0;
      width: 100vw;
      height: calc(100vh - 80px);
    }
    .sidebar {
      width: 30%;
      background: var(--bg-c);
      border-radius: 10px 0 0 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    .main-area {
      width: 70%;
      background: var(--bg-c);
      border-radius: 0 10px 10px 0;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .placeholder-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 24px;
    }
    .compose-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--save-button);
      color: var(--text-primary);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    .compose-btn:hover {
      opacity: 0.8;
    }
    .compose-form {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid var(--background-input);
      border-radius: 8px;
      background: var(--background-settings);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--text-primary);
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--background-input);
      border-radius: 4px;
      background: var(--background-input);
      color: var(--text-primary);
      font-family: inherit;
    }
    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }
    .send-btn {
      background: var(--save-button);
      color: var(--text-primary);
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .send-btn:hover {
      opacity: 0.8;
    }
    .send-btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
    }
    .emails-list {
      margin-top: 30px;
    }
    .email-item {
      border: 1px solid var(--background-input);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--background-settings);
      cursor: pointer;
    }
    .email-item:hover {
      background: var(--background-input);
    }
    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .email-to {
      font-weight: bold;
      color: var(--text-primary);
    }
    .email-subject {
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    .email-date {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .email-body {
      color: var(--text-primary);
      white-space: pre-wrap;
      margin-top: 10px;
      padding: 10px;
      background: var(--background-input);
      border-radius: 4px;
    }
    .delete-btn {
      background: var(--reset-button);
      color: var(--text-primary);
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      opacity: 0.8;
    }
    .user-email {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      color: var(--text-primary);
    }
    .loading {
      text-align: center;
      color: var(--text-secondary);
    }
    .email-view {
      width: 100%;
      height: 100%;
      display: none;
    }
    .email-view.show {
      display: block;
    }
  </style>
</head>

<body class="center">
  <div class="f-nav"></div>
  <div id="t">Mail</div>
  <div id="particles-js">
    <div class="main">
      <div class="mail-layout">
        <div class="sidebar">
          <h1 style="text-align: center; color: var(--text-primary);">Inbox</h1>
          <div id="user-email" class="user-email"></div>
          <div class="emails-list">
            <div id="emails-container">
              <div class="loading">Loading emails...</div>
            </div>
          </div>
        </div>
        <div class="main-area">
          <div class="placeholder-text">Select an email or compose one!</div>
          <div class="email-view" id="email-view"></div>
          <div class="compose-form" id="compose-form" style="display: none;">
            <h2 style="color: var(--text-primary);">Compose Email</h2>
            <form id="email-form">
              <div class="form-group">
                <label for="to">To:</label>
                <input type="email" id="to" required placeholder="recipient@example.com">
              </div>
              <div class="form-group">
                <label for="subject">Subject:</label>
                <input type="text" id="subject" required placeholder="Email subject">
              </div>
              <div class="form-group">
                <label for="body">Message:</label>
                <textarea id="body" required placeholder="Type your message here..."></textarea>
              </div>
              <button type="submit" class="send-btn" id="send-btn">Send Email</button>
            </form>
          </div>
        </div>
      </div>
      <button class="compose-btn" id="compose-btn">+</button>
    </div>
  </div>

  <script>
    // Check device token on page load
    async function checkAuth() {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) {
        window.location.href = '/signin';
        return;
      }

      try {
        const response = await fetch('/api/validate-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken })
        });

        const data = await response.json();
        if (!data.valid) {
          localStorage.removeItem('deviceToken');
          window.location.href = '/signin';
        } else {
          // Load user email and emails
          loadUserEmail();
          loadEmails();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/signin';
      }
    }

    async function loadUserEmail() {
      try {
        const response = await fetch('/api/server-info');
        const data = await response.json();
        const deviceToken = localStorage.getItem('deviceToken');
        const userResponse = await fetch('/api/validate-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken })
        });
        const userData = await userResponse.json();
        const userEmail = `${userData.user.username}@${data.domain}`;
        document.getElementById('user-email').textContent = `Your email: ${userEmail}`;
      } catch (error) {
        console.error('Failed to load user email:', error);
      }
    }

    async function loadEmails() {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        const response = await fetch(`/api/emails?deviceToken=${encodeURIComponent(deviceToken)}`);
        const emails = await response.json();

        const container = document.getElementById('emails-container');
        if (emails.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No sent emails yet.</p>';
          return;
        }

        container.innerHTML = emails.map(email => `
          <div class="email-item" onclick="viewEmail(${email.id}, '${email.to_email}', '${email.subject}', '${email.body.replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${email.sent_at}')">
            <div class="email-header">
              <div>
                <div class="email-to">To: ${email.to_email}</div>
                <div class="email-date">${new Date(email.sent_at).toLocaleString()}</div>
              </div>
              <button onclick="deleteEmail(event, ${email.id})" class="delete-btn">Delete</button>
            </div>
            <div class="email-subject"><strong>Subject:</strong> ${email.subject}</div>
            <div class="email-body">${email.body}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load emails:', error);
        document.getElementById('emails-container').innerHTML = '<p style="text-align: center; color: var(--reset-button);">Failed to load emails.</p>';
      }
    }

    function viewEmail(id, to, subject, body, sentAt) {
      const emailView = document.getElementById('email-view');
      const placeholder = document.querySelector('.placeholder-text');
      const composeForm = document.getElementById('compose-form');

      placeholder.style.display = 'none';
      composeForm.style.display = 'none';
      emailView.classList.add('show');

      emailView.innerHTML = `
        <div class="email-item" style="border: none; background: transparent; cursor: default;">
          <div class="email-header">
            <div>
              <div class="email-to">To: ${to}</div>
              <div class="email-date">${new Date(sentAt).toLocaleString()}</div>
            </div>
          </div>
          <div class="email-subject"><strong>Subject:</strong> ${subject}</div>
          <div class="email-body">${body.replace(/\\n/g, '\n')}</div>
        </div>
      `;
    }

    function showCompose() {
      const placeholder = document.querySelector('.placeholder-text');
      const emailView = document.getElementById('email-view');
      const composeForm = document.getElementById('compose-form');

      placeholder.style.display = 'none';
      emailView.classList.remove('show');
      composeForm.style.display = 'block';
    }

    async function deleteEmail(event, emailId) {
      event.stopPropagation(); // Prevent triggering viewEmail

      if (!confirm('Are you sure you want to delete this email?')) return;

      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        const response = await fetch(`/api/emails/${emailId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken })
        });

        if (response.ok) {
          loadEmails(); // Reload emails
          // Reset main area to placeholder if the deleted email was being viewed
          const emailView = document.getElementById('email-view');
          if (emailView.classList.contains('show')) {
            emailView.classList.remove('show');
            document.querySelector('.placeholder-text').style.display = 'block';
          }
        } else {
          alert('Failed to delete email');
        }
      } catch (error) {
        console.error('Failed to delete email:', error);
        alert('Failed to delete email');
      }
    }

    // Handle form submission
    document.getElementById('email-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const sendBtn = document.getElementById('send-btn');
      const originalText = sendBtn.textContent;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      const deviceToken = localStorage.getItem('deviceToken');
      const to = document.getElementById('to').value;
      const subject = document.getElementById('subject').value;
      const body = document.getElementById('body').value;

      try {
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken, to, subject, body })
        });

        const result = await response.json();

        if (response.ok) {
          alert('Email sent successfully!');
          document.getElementById('email-form').reset();
          loadEmails(); // Reload emails to show the new one
          // Hide compose form and show placeholder
          document.getElementById('compose-form').style.display = 'none';
          document.querySelector('.placeholder-text').style.display = 'block';
        } else {
          alert('Failed to send email: ' + result.message);
        }
      } catch (error) {
        console.error('Failed to send email:', error);
        alert('Failed to send email');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
      }
    });

    // Check auth on load
    checkAuth();

    // Add event listener for compose button
    document.getElementById('compose-btn').addEventListener('click', () => {
      const composeForm = document.getElementById('compose-form');
      const placeholder = document.querySelector('.placeholder-text');
      const emailView = document.getElementById('email-view');
      const mainArea = document.querySelector('.main-area');

      if (composeForm.style.display === 'block') {
        // Close compose
        composeForm.style.display = 'none';
        placeholder.style.display = 'block';
        // Reset main-area
        mainArea.style.display = 'flex';
        mainArea.style.alignItems = 'center';
        mainArea.style.justifyContent = 'center';
        composeForm.style.width = '';
        composeForm.style.height = '';
      } else {
        // Open compose
        placeholder.style.display = 'none';
        emailView.classList.remove('show');
        composeForm.style.display = 'block';
        // Make compose fill main-area
        mainArea.style.display = 'block';
        mainArea.style.alignItems = 'stretch';
        mainArea.style.justifyContent = 'stretch';
        composeForm.style.width = '100%';
        composeForm.style.height = '100%';
        composeForm.style.boxSizing = 'border-box';
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script src="/assets/js/h1.js"></script>
  <script src="/assets/js/m1.js"></script>
</body>

</html>
