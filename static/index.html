<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" id="tab-favicon" href="favicon.png" />
  <title id="t">Home</title>
  <link rel="stylesheet" href="/assets/css/global.css?v=6" />
  <link rel="stylesheet" href="/assets/css/h.css?v=01" />
  <link rel="stylesheet" href="/assets/css/nav.css?v=01" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="center" onload="SplashT">
  <div class="f-nav"></div>
  <div id="particles-js">
    <div class="main">
      <div id="notifications" class="notifications" style="display: none;"></div>
      <div id="welcome-container" class="title">
        <span id="welcome-text">Welcome</span>
      </div>
      <p id="splash"></p>
      <div class="search-container">
        <form id="fv" method="POST">
          <input id="input" class="truncate" placeholder="Search or enter a URL" type="text" />
        </form>
        <button id="search-history-btn" class="search-history-btn" title="View Search History">
          <i class="fas fa-history"></i>
        </button>
      </div>
      <div class="now-playing">
        <span>Now Playing: <span id="song-title">morning tape - nilöwh.</span> <button id="audio-control" class="audio-btn"><i class="fas fa-pause"></i></button></span>
      </div>
    </div>
  </div>

  <script>
    // Check device token on page load
    async function checkAuth() {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) {
        window.location.href = '/signin';
        return;
      }

      try {
        const response = await fetch('/api/validate-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken })
        });

        const data = await response.json();
        if (!data.valid) {
          localStorage.removeItem('deviceToken');
          window.location.href = '/signin';
        } else {
          // Load notifications after auth check
          loadNotifications();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/signin';
      }
    }

    // Load and display notifications
    async function loadNotifications() {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        const response = await fetch(`/api/undismissed-messages?deviceToken=${encodeURIComponent(deviceToken)}`);
        const messages = await response.json();

        if (messages.length > 0) {
          const notificationsDiv = document.getElementById('notifications');
          notificationsDiv.innerHTML = messages.map(msg => `
            <div class="notification" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-bottom: 15px; position: relative;">
              <button onclick="dismissNotification(${msg.id})" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 18px; cursor: pointer; color: #666;">×</button>
              <strong>Admin Notification:</strong><br>
              ${msg.message}
            </div>
          `).join('');
          notificationsDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to load notifications:', error);
      }
    }

    // Dismiss notification
    async function dismissNotification(messageId) {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        await fetch('/api/dismiss-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken, messageId })
        });
        // Reload notifications
        loadNotifications();
      } catch (error) {
        console.error('Failed to dismiss notification:', error);
      }
    }

    // Check auth immediately
    checkAuth();

    // Search history functionality
    document.getElementById('search-history-btn').addEventListener('click', showSearchHistory);

    async function showSearchHistory() {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        const response = await fetch(`/api/search-history?deviceToken=${encodeURIComponent(deviceToken)}`);
        const history = await response.json();

        // Create modal
        const modal = document.createElement('div');
        modal.id = 'search-history-modal';
        modal.innerHTML = `
          <div class="modal-overlay" onclick="closeSearchHistoryModal()"></div>
          <div class="modal-content">
            <div class="modal-header">
              <h2>Search History</h2>
              <button onclick="closeSearchHistoryModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
              ${history.length === 0 ? '<p>No search history found.</p>' :
                history.map(item => `
                  <div class="history-item">
                    <div class="history-info">
                      <div class="history-title">${item.title || item.url}</div>
                      <div class="history-url">${item.url}</div>
                      <div class="history-date">${new Date(item.visited_at).toLocaleString()}</div>
                    </div>
                    <div class="history-actions">
                      <button onclick="visitHistoryItem('${item.url}')" class="visit-btn">Visit</button>
                      <button onclick="deleteHistoryItem(${item.id})" class="delete-btn">Delete</button>
                    </div>
                  </div>
                `).join('')
              }
            </div>
            <div class="modal-footer">
              <button onclick="clearAllHistory()" class="clear-btn">Clear All History</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Add modal styles
        const style = document.createElement('style');
        style.textContent = `
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
          }
          .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-c);
            border-radius: 10px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          }
          .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
            margin-bottom: 15px;
          }
          .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
          }
          .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
          }
          .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
          }
          .history-info {
            flex: 1;
          }
          .history-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
          }
          .history-url {
            color: var(--text-secondary, #888);
            font-size: 14px;
            margin-bottom: 5px;
            word-break: break-all;
          }
          .history-date {
            color: var(--text-secondary, #666);
            font-size: 12px;
          }
          .history-actions {
            display: flex;
            gap: 10px;
          }
          .visit-btn, .delete-btn, .clear-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
          }
          .visit-btn {
            background: #007bff;
            color: white;
          }
          .delete-btn {
            background: #dc3545;
            color: white;
          }
          .clear-btn {
            background: #ffc107;
            color: black;
            padding: 8px 16px;
          }
          .modal-footer {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 15px;
          }
        `;
        document.head.appendChild(style);

      } catch (error) {
        console.error('Failed to load search history:', error);
        alert('Failed to load search history');
      }
    }

    function closeSearchHistoryModal() {
      const modal = document.getElementById('search-history-modal');
      if (modal) {
        modal.remove();
      }
    }

    function visitHistoryItem(url) {
      closeSearchHistoryModal();
      // Use the existing processUrl function
      processUrl(url);
    }

    async function deleteHistoryItem(id) {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        await fetch(`/api/search-history/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken })
        });
        // Refresh the modal
        closeSearchHistoryModal();
        showSearchHistory();
      } catch (error) {
        console.error('Failed to delete history item:', error);
        alert('Failed to delete history item');
      }
    }

    async function clearAllHistory() {
      if (!confirm('Are you sure you want to clear all search history?')) return;

      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        await fetch('/api/search-history', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken })
        });
        closeSearchHistoryModal();
        showSearchHistory();
      } catch (error) {
        console.error('Failed to clear history:', error);
        alert('Failed to clear history');
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <audio id="menu-audio" autoplay>
     <source src="assets/media/audio/menu.mp3" type="audio/mpeg">
  </audio>
  <script src="assets/js/index-3.js"></script>
  <script src="/assets/js/h1.js"></script>
  <script src="./assets/mathematics/bundle.js?v=2025-04-15"></script>
  <script src="./assets/mathematics/config.js?v=2025-04-15"></script>
  <script src="/assets/js/m1.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let selectedSong;
      let songName;
      // king von 
      if (Math.random() < 0.0033) {
        selectedSong = ' - Armed _ Dangerous - King Von.mp3';
        songName = ' - Armed _ Dangerous - King Von';
        // normal shit
      } else {
        const audioFiles = ['Bliss.mp3', 'Broken Attachment.mp3', 'Frank Saint.mp3', 'Goodnight Dad I Love You.mp3', 'hide the pain.mp3', 'menu.mp3', 'milk cassette x.mp3', 'old memories of you.mp3', 'pointless.mp3', 'sakura zxc.mp3', 'see you in heaven.mp3', 'Song For Those Who Keep Silent.mp3', 'The Lobotomy.mp3', 'thought you were sweet.mp3'];
        const randomIndex = Math.floor(Math.random() * audioFiles.length);
        selectedSong = audioFiles[randomIndex];
        songName = selectedSong.replace(/\.mp3$/, '');
      }

      const audio = document.getElementById('menu-audio');
      audio.querySelector('source').src = `assets/media/audio/${selectedSong}`;
      document.getElementById('song-title').textContent = songName;

      audio.volume = 0.65;
      const audioControl = document.getElementById('audio-control');
      const icon = audioControl.querySelector('i');

      audioControl.addEventListener('click', function() {
        if (audio.paused) {
          audio.play();
          icon.className = 'fas fa-pause';
        } else {
          audio.pause();
          icon.className = 'fas fa-play';
        }
      });
    });
  </script>
</body>

</html>
