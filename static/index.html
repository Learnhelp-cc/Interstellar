<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" id="tab-favicon" href="favicon.png" />
  <title id="t">Home</title>
  <link rel="stylesheet" href="/assets/css/global.css?v=6" />
  <link rel="stylesheet" href="/assets/css/h.css?v=01" />
  <link rel="stylesheet" href="/assets/css/nav.css?v=01" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="center" onload="SplashT">
  <div class="f-nav"></div>
  <div id="particles-js">
    <div class="main">
      <div id="notifications" class="notifications" style="display: none;"></div>
      <div id="welcome-container" class="title">
        <span id="welcome-text">Welcome</span>
      </div>
      <p id="splash"></p>
      <div class="search-container">
        <form id="fv" method="POST">
          <input id="input" class="truncate" placeholder="Search or enter a URL" type="text" />
        </form>
      </div>
      <div class="now-playing">
        <span>Now Playing: <span id="song-title">morning tape - nilöwh.</span> <button id="audio-control" class="audio-btn"><i class="fas fa-pause"></i></button></span>
      </div>
    </div>
  </div>

  <script>
    // Check device token on page load
    async function checkAuth() {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) {
        window.location.href = '/signin';
        return;
      }

      try {
        const response = await fetch('/api/validate-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken })
        });

        const data = await response.json();
        if (!data.valid) {
          localStorage.removeItem('deviceToken');
          window.location.href = '/signin';
        } else {
          // Load notifications after auth check
          loadNotifications();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/signin';
      }
    }

    // Load and display notifications
    async function loadNotifications() {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        const response = await fetch(`/api/undismissed-messages?deviceToken=${encodeURIComponent(deviceToken)}`);
        const messages = await response.json();

        if (messages.length > 0) {
          const notificationsDiv = document.getElementById('notifications');
          notificationsDiv.innerHTML = messages.map(msg => `
            <div class="notification" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-bottom: 15px; position: relative;">
              <button onclick="dismissNotification(${msg.id})" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 18px; cursor: pointer; color: #666;">×</button>
              <strong>Admin Notification:</strong><br>
              ${msg.message}
            </div>
          `).join('');
          notificationsDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to load notifications:', error);
      }
    }

    // Dismiss notification
    async function dismissNotification(messageId) {
      const deviceToken = localStorage.getItem('deviceToken');
      if (!deviceToken) return;

      try {
        await fetch('/api/dismiss-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deviceToken, messageId })
        });
        // Reload notifications
        loadNotifications();
      } catch (error) {
        console.error('Failed to dismiss notification:', error);
      }
    }

    // Check auth immediately
    checkAuth();
  </script>
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <audio id="menu-audio" autoplay>
     <source src="assets/media/audio/menu.mp3" type="audio/mpeg">
  </audio>
  <script src="assets/js/index-3.js"></script>
  <script src="/assets/js/h1.js"></script>
  <script src="./assets/mathematics/bundle.js?v=2025-04-15"></script>
  <script src="./assets/mathematics/config.js?v=2025-04-15"></script>
  <script src="/assets/js/m1.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let selectedSong;
      let songName;
      if (Math.random() < 0.0033) {
        selectedSong = ' - Armed _ Dangerous - King Von.mp3';
        songName = ' - Armed _ Dangerous - King Von';
      } else {
        const audioFiles = ['Bliss.mp3', 'Broken Attachment.mp3', 'Frank Saint.mp3', 'Goodnight Dad I Love You.mp3', 'hide the pain.mp3', 'menu.mp3', 'milk cassette x.mp3', 'old memories of you.mp3', 'pointless.mp3', 'sakura zxc.mp3', 'see you in heaven.mp3', 'Song For Those Who Keep Silent.mp3', 'The Lobotomy.mp3', 'thought you were sweet.mp3'];
        const randomIndex = Math.floor(Math.random() * audioFiles.length);
        selectedSong = audioFiles[randomIndex];
        songName = selectedSong.replace(/\.mp3$/, '');
      }

      const audio = document.getElementById('menu-audio');
      audio.querySelector('source').src = `assets/media/audio/${selectedSong}`;
      document.getElementById('song-title').textContent = songName;

      audio.volume = 0.65;
      const audioControl = document.getElementById('audio-control');
      const icon = audioControl.querySelector('i');

      audioControl.addEventListener('click', function() {
        if (audio.paused) {
          audio.play();
          icon.className = 'fas fa-pause';
        } else {
          audio.pause();
          icon.className = 'fas fa-play';
        }
      });
    });
  </script>
</body>

</html>
